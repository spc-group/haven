[project]
name = "haven-spc"
version = "2025.02.1"
authors = [
  { name="Mark Wolfman", email="wolfman@anl.gov" },
]
description = "Tools and GUI for running the spectroscopy group beamlines at the Advanced Photon Source."
readme = "README.md"
# requires-python = ">=3.12"
classifiers = [
    "Programming Language :: Python :: 3",
    "Operating System :: OS Independent",
    "Development Status :: 3 - Alpha",
    "Topic :: Scientific/Engineering",
    "Topic :: System :: Hardware",
]
license = "BSD-3-clause"
keywords = ["synchrotron", "xray", "bluesky"]
dependencies = [
    # Managed by pixi
    # To-do: what dependencies do we actually need for e.g. pip install.
]


[project.urls]
"Homepage" = "https://haven-spc.readthedocs.io/en/latest/"
"Bug Tracker" = "https://github.com/spc-group/haven/issues"

[project.entry-points."pydm.data_plugin"]
HavenPlugin = "firefly.pydm_plugin:HavenPlugin"

[project.scripts]
haven_config = "haven._iconfig:print_config_value"
databroker_consumer = "haven_qserver.databroker_consumer:main"
tiled_consumer = "haven_qserver.tiled_consumer:main"

[project.gui-scripts]
firefly = "firefly.launcher:main"
firefly_cameras = "firefly.launcher:cameras"

[build-system]
build-backend = "hatchling.build"
requires = ["hatchling"]

[tool.hatch.build.targets.wheel]
packages = ["src/haven", "src/firefly", "src/haven_qserver"]

[tool.isort]
profile = "black"

[tool.versioneer]
VCS = "git"
style = "pep440"
versionfile_source = "src/haven/_version.py"
versionfile_build = "haven/_version.py"
tag_prefix = "haven-"
parentdir_prefix = "haven-"

[tool.mypy]
files = [
    'src/firefly/bss.py', 'src/firefly/tests/test_bss_display.py',
    'src/firefly/energy.py', 'src/firefly/tests/test_energy_display.py',
    'src/firefly/devices/axilon_monochromator.py', 'src/firefly/tests/test_monochromator.py',
    'src/firefly/devices/undulator.py', 'src/firefly/tests/test_undulator.py',
    'src/firefly/plans/count.py', 'src/firefly/tests/test_count_window.py',
    'src/firefly/plans/duration_label.py', 'src/firefly/tests/test_duration_label.py',
    'src/firefly/plans/metadata.py', 'src/firefly/tests/test_metadata_widget.py',
    'src/firefly/plans/move_motor_window.py', 'src/firefly/tests/test_move_motor_window.py',
    'src/firefly/plans/regions.py', 'src/firefly/tests/test_regions.py',
    'src/firefly/plans/plan_display.py', 'src/firefly/tests/test_plan_display.py',
    'src/firefly/plans/line_scan.py', 'src/firefly/tests/test_line_scan_window.py',
    'src/firefly/plans/grid_scan.py', 'src/firefly/tests/test_grid_scan_window.py',
    'src/firefly/plans/relative_checkbox.py', 'src/firefly/tests/test_relative_checkbox.py',
    'src/firefly/plans/util.py',
    'src/firefly/plans/xafs_scan.py', 'src/firefly/tests/test_xafs_scan.py',
    'src/haven/run_engine.py', 'src/haven/tests/test_run_engine.py',
    'src/haven/devices/asymmotron.py', "src/haven/tests/test_asymmotron.py",
    "src/haven/bss.py", "src/haven/tests/test_bss.py",
    'src/haven/devices/blade_slits.py', "src/haven/tests/test_blade_slits.py",
    'src/haven/devices/ion_chamber.py', "src/haven/tests/test_ion_chamber.py",
    'src/haven/devices/motor.py', "src/haven/tests/test_motor.py",
    'src/haven/plans/_robot_transfer_sample.py', "src/haven/tests/test_robot_transfer_sample.py",
    'src/haven/devices/undulator.py', "src/haven/tests/test_undulator.py",
    'src/haven/devices/vacuum.py', 'src/haven/tests/test_vacuum_devices.py',
    'src/haven/plans/_calibrate.py', 'src/haven/tests/test_calibrate_plan.py',
    'src/haven/plans/_set_energy.py', 'src/haven/tests/test_set_energy.py',
    'src/haven/plans/_xafs_scan.py', 'src/haven/plans/_energy_scan.py', 'src/haven/tests/test_energy_xafs_scan.py',
    'src/haven/positioner.py', "src/haven/tests/test_positioner.py",
]
follow_imports = "skip"
follow_untyped_imports = true

[tool.pixi.workspace]
channels = ["conda-forge"]
platforms = ["linux-64"]

[tool.pixi.activation.env]
PYDM_DEFAULT_PROTOCOL = "ca"

[tool.pixi.dependencies]
httpx = "*"
lmfit = "*"
mergedeep = "*"
pint = "*"
pcdsdevices = "*"
rich = "*"
scipy = "*"
stamina = "*"
tomlkit = "*"
xraydb = ">=4.5.0"
xrayutilities = "*"

[tool.pixi.pypi-dependencies]
haven-spc = { path = ".", editable = true }
tiled = { version = "==0.1.0b29", extras = ["client"] }

[tool.pixi.environments]
default = { solve-group = "default" }
dev = { features = ["bluesky", "ipython", "dev", "gui"], solve-group = "default" }
25idc = { features = ["bluesky", "ipython", "25idc", "gui", "qserver", "tiled-server"], solve-group = "default" }
25idd = { features = ["bluesky", "ipython", "25idd", "gui", "qserver", "tiled-server"], solve-group = "default" }
qa = { features = ["bluesky", "ipython", "qa", "gui", "qserver", "tiled-server"], solve-group = "default" }
designer = { features = ["designer"] }

[tool.pixi.tasks]
test-all = [
    {task = "lint" },
    {task = "format", args = ["--check"] },
    {task = "isort", args = ["--check"] },
    {task = "check-types" },
    {task = "test-haven" },
    {task = "test-firefly" }
]

[tool.pixi.feature.bluesky.dependencies]
aioca = "*"
aiokafka = "*"  # ==0.12.0",
bluesky = "*"  #==1.14.2",
# bluesky-adaptive = "*"
# bluesky-queueserver" = ">=0.0.23",
# bluesky-queueserver-api = "*"  #  = ">=0.0.12"
bluesky-tiled-plugins = ">=2.0.0b64"
databroker = "==1.2.5"  # Just to make the solve work for apsbits
ophyd = "*"  # =1.10.7",

[tool.pixi.feature.bluesky.pypi-dependencies]
apsbits = "*"
apstools = "*"  # ==1.7.3",
guarneri = "*"  # ==0.2.0",
ophyd-async = "==0.10.1"
bluesky-adaptive = "*"
bluesky-queueserver-api = "*"  #  = ">=0.0.12"


[tool.pixi.feature.dev.dependencies]
"pytest" = "*"
"pytest-httpx" = "*"
"pytest-mock" = "*"
"pytest-qt" = "*"
"pytest-xvfb" = "*"
"pytest-asyncio" = "*"
"black" = "*"
"twine" = "*"
"time-machine" = "*"
"flake8" = "*"
"isort" = "*"
"sphinx" = "*"
"nbsphinx" = "*"
"graphviz" = "*"
"sphinxcontrib-napoleon" = "*"
"scipy-stubs" = "*"
"mypy" = "*"

[tool.pixi.feature.ipython]
dependencies = {ipython = "*"}
tasks = {ipython = "ipython -i ./src/haven/ipython_startup.ipy"}

[tool.pixi.feature.dev.pypi-dependencies]
autoapi = "*"
build = "*"

[tool.pixi.feature.dev.tasks]
test-haven = "pytest src/haven"
test-firefly = "pytest src/firefly"
check-types = "mypy"
lint = "flake8 --count --select=E9,F63,F7,F82,F401 --show-source --statistics src/"
make-docs = "make html --directory=docs/"

[tool.pixi.feature.dev.tasks.isort]
args = [
     { arg = "check_flag", default = "" },
]
cmd = "isort src {{ check_flag }}"

[tool.pixi.feature.dev.tasks.format]
args = [
     { arg = "check_flag", default = "" },
]
cmd = "black src {{ check_flag }}"

[tool.pixi.feature.gui.dependencies]
qtawesome = ">=1.4.0"
pydm = "==1.25.2"
pyqtgraph = "*"
qasync = "*"
bluesky-widgets = "*"
typhos = ">=3.1.0"  # need the find_signal method on the SignalConnection()
qt = ">=5.15"
pyqt = ">=5.15"

[tool.pixi.feature.gui.pypi-dependencies]
apsbss = "*"

[tool.pixi.feature.gui.tasks]
firefly = "firefly"

[tool.pixi.feature.designer.dependencies]
python = "3.10.*"
pyqt = "==5.12.3"
pyqtgraph = "<0.13.0"  # Last version to support pyqt 5.12
qt = "~=5.12"
pydm = "==1.25.2"

[tool.pixi.feature.designer.tasks]
designer = "designer"

[tool.pixi.feature.qserver]
tasks = {qserver = "python -m haven_qserver.launch_queueserver"}
pypi-dependencies = {bluesky-queueserver = {"git" = "https://github.com/bluesky/bluesky-queueserver"}}

[tool.pixi.feature.tiled-server.pypi-dependencies]
tiled = { version = "==0.1.0b29", extras = ["all"] }

[tool.pixi.feature.tiled-server.tasks]
tiled = "tiled serve config"

[tool.pixi.feature.qa.activation.env]
BLUESKY_DIR = "~/.config/bluesky/"
HAVEN_CONFIG_FILES = "${BLUESKY_DIR}iconfig.toml"
TILED_CONFIG = "${HOME}/.config/tiled/server_config.yml"
QSERVER_ZMQ_CONTROL_ADDRESS = "tcp://localhost:60617"

# Per beamline configuration
[tool.pixi.feature.25idc.activation.env]
BLUESKY_DIR = "/net/s25data/xorApps/bluesky/25idc/"
HAVEN_CONFIG_FILES = "${BLUESKY_DIR}iconfig.toml"
TILED_CONFIG = "${BLUESKY_DIR}tiled_server_config.yml"
QSERVER_ZMQ_CONTROL_ADDRESS = "tcp://fedorov.xray.aps.anl.gov:60615"

[tool.pixi.feature.25idd.activation.env]
BLUESKY_DIR = "/net/s25data/xorApps/bluesky/25idd/"
HAVEN_CONFIG_FILES = "${BLUESKY_DIR}iconfig.toml"
TILED_CONFIG = "${BLUESKY_DIR}tiled_server_config.yml"
QSERVER_ZMQ_CONTROL_ADDRESS = "tcp://fedorov.xray.aps.anl.gov:60616"
