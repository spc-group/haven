[workspace]
channels = ["conda-forge"]
platforms = ["linux-64"]

[activation.env]
PYDM_DEFAULT_PROTOCOL = "ca"

[dependencies]
httpx = "*"
lmfit = "*"
mergedeep = "*"
pint = "*"
pcdsdevices = "*"
rich = "*"
scipy = "*"
stamina = "*"
tomlkit = "*"
xraydb = ">=4.5.0"
xrayutilities = "*"

[pypi-dependencies]
haven-spc = { path = ".", editable = true }

[environments]
default = { solve-group = "default" }
dev = { features = ["bluesky", "ipython", "dev", "gui", "tiled"], solve-group = "default" }
qa = { features = ["bluesky", "ipython", "qa", "gui", "qserver", "tiled"], solve-group = "default" }
25idc = { features = ["bluesky", "ipython", "25idc", "gui", "qserver", "tiled"], solve-group = "default" }
25idd = { features = ["bluesky", "ipython", "25idd", "gui", "qserver", "tiled"], solve-group = "default" }
designer = { features = ["designer"] }

[tasks]
test-all = [
    {task = "lint" },
    {task = "format", args = ["--check"] },
    {task = "isort", args = ["--check"] },
    {task = "check-types" },
    {task = "test-haven" },
    {task = "test-firefly" }
]

[feature.bluesky.dependencies]
aioca = "*"
aiokafka = "*"  # ==0.12.0",
bluesky = "==1.14.4"
# bluesky-adaptive = "*"
# bluesky-queueserver = ">=0.0.23",
# bluesky-queueserver-api = "*"  #  = ">=0.0.12"
databroker = "==1.2.5"  # Just to make the solve work for apsbits
ophyd = "*"  # =1.10.7",

[feature.bluesky.pypi-dependencies]
apsbits = "*"
apstools = "*"  # ==1.7.3",
guarneri = "*"  # ==0.2.0",
ophyd-async = "==0.10.1"
bluesky-adaptive = "*"
bluesky-queueserver-api = "*"  #  = ">=0.0.12"


[feature.dev.dependencies]
"pytest" = "*"
"pytest-httpx" = "*"
"pytest-mock" = "*"
"pytest-qt" = "*"
"pytest-xvfb" = "*"
"pytest-asyncio" = "*"
"black" = "*"
"twine" = "*"
"time-machine" = "*"
"ruff" = "*"
"isort" = "*"
"sphinx" = "*"
"nbsphinx" = "*"
"graphviz" = "*"
"sphinxcontrib-napoleon" = "*"
"scipy-stubs" = "*"
"mypy" = "*"
pytest-timeout = ">=2.4.0,<3"

[feature.ipython]
dependencies = {ipython = "*"}
tasks = {ipython = "ipython -i ./src/haven/startup.py"}

[feature.dev.pypi-dependencies]
autoapi = "*"
build = "*"

[feature.dev.tasks]
test-haven = "pytest src/haven"
test-firefly = "pytest src/firefly"
check-types = "mypy"
lint = "ruff check"
make-docs = "make html --directory=docs/"

[feature.dev.tasks.isort]
args = [
     { arg = "check_flag", default = "" },
]
cmd = "isort src {{ check_flag }}"

[feature.dev.tasks.format]
args = [
     { arg = "check_flag", default = "" },
]
cmd = "black src {{ check_flag }}"

[feature.gui.dependencies]
qtawesome = ">=1.4.0"
pydm = "==1.25.2"
pyqtgraph = "*"
qasync = "*"
bluesky-widgets = "*"
typhos = ">=3.1.0"  # need the find_signal method on the SignalConnection()
qt = ">=5.15"
pyqt = ">=5.15"

[feature.gui.pypi-dependencies]
apsbss = "*"

[feature.gui.tasks]
firefly = "firefly"
run_browser = "firefly --no-instrument --no-queue run_browser"

[feature.designer.dependencies]
python = "3.10.*"
pyqt = "==5.12.3"
pyqtgraph = "<0.13.0"  # Last version to support pyqt 5.12
qt = "~=5.12"
pydm = "==1.25.2"

[feature.designer.tasks]
designer = "designer"

[feature.qserver]
tasks = {qserver = "python -m haven_qserver.launch_queueserver"}
pypi-dependencies = {bluesky-queueserver = {"git" = "https://github.com/bluesky/bluesky-queueserver"}}

[feature.tiled.pypi-dependencies]
# tiled = {url = "https://github.com/spc-group/tiled/releases/download/v0.1.0b36/tiled-0.1.0b37.dev7+g52f22d8cb-py3-none-any.whl", extras=["all"]}
tiled = {path = "../tiled", extras=["all"], editable=true}
bluesky-tiled-plugins = ">=2.0.0b68"

[feature.tiled.tasks]
tiled = "tiled serve config"

# Configuration for quality assurance testing before release
[feature.qa.activation.env]
BLUESKY_DIR = "/net/s25data/xorApps/bluesky/qa/"
HAVEN_CONFIG_FILES = "${BLUESKY_DIR}iconfig.toml"
TILED_CONFIG = "${BLUESKY_DIR}/tiled_server_config.yml"
QSERVER_ZMQ_CONTROL_ADDRESS = "tcp://localhost:60617"
QSERVER_ZMQ_CONTROL_ADDRESS_FOR_SERVER = "tcp://*:60617"
QSERVER_ZMQ_INFO_ADDRESS = "tcp://localhost:60627"
QSERVER_ZMQ_INFO_ADDRESS_FOR_SERVER = "tcp://*:60627"

# Per beamline configuration
[feature.25idc.activation.env]
BLUESKY_DIR = "/net/s25data/xorApps/bluesky/25idc/"
HAVEN_CONFIG_FILES = "${BLUESKY_DIR}iconfig.toml"
TILED_CONFIG = "${BLUESKY_DIR}tiled_server_config.yml"
QSERVER_ZMQ_CONTROL_ADDRESS = "tcp://fedorov.xray.aps.anl.gov:60615"
QSERVER_ZMQ_CONTROL_ADDRESS_FOR_SERVER = "tcp://*:60615"
QSERVER_ZMQ_INFO_ADDRESS = "tcp://fedorov.xray.aps.anl.gov:60625"
QSERVER_ZMQ_INFO_ADDRESS_FOR_SERVER = "tcp://*:60625"

[feature.25idd.activation.env]
BLUESKY_DIR = "/net/s25data/xorApps/bluesky/25idd/"
HAVEN_CONFIG_FILES = "${BLUESKY_DIR}iconfig.toml"
TILED_CONFIG = "${BLUESKY_DIR}tiled_server_config.yml"
QSERVER_ZMQ_CONTROL_ADDRESS = "tcp://fedorov.xray.aps.anl.gov:60616"
QSERVER_ZMQ_CONTROL_ADDRESS_FOR_SERVER = "tcp://*:60616"
QSERVER_ZMQ_INFO_ADDRESS = "tcp://fedorov.xray.aps.anl.gov:60626"
QSERVER_ZMQ_INFO_ADDRESS_FOR_SERVER = "tcp://*:60626"
